<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Western Upside Down Island</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #111;
      overflow: hidden;
    }
    #game-container {
      width: clamp(800px, 100vw, 1600px);
      height: clamp(600px, 100vh, 900px);
      margin: auto;
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
      background: #000;
    }

    canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  <div id="game-container"></div>
  <script>
    const config = {
      type: Phaser.AUTO,
      parent: 'game-container',
      backgroundColor: '#222',
      scale: {
        mode: Phaser.Scale.RESIZE,
        autoCenter: Phaser.Scale.CENTER_BOTH
      },
      physics: {
          default: 'arcade',
          arcade: {
              gravity: { y: 300 },
              debug: false
          }
      },
      scene: { preload: preload, create: create, update: update }
    };

    const game = new Phaser.Game(config);

    function preload() {
      this.load.image('forward_e', 'assets/Explorepheus/forward.png');
      this.load.image('left_moving', 'assets/Explorepheus/left_moving.png');
      this.load.image('right_moving', 'assets/Explorepheus/right_moving.png');
      this.load.image('left_still', 'assets/Explorepheus/left_still.png');
      this.load.image('right_still', 'assets/Explorepheus/right_still.png');
      this.load.image('message_box','assets/bro.png');
      this.load.image('msg','assets/Component.png');
      this.load.image('mainmsg','assets/main.png');
      this.load.spritesheet('background','assets/Terrain (32x32).png', { frameWidth: 32, frameHeight: 32 });
      this.load.spritesheet('elevator','assets/SimpleElevatorDoors_animated_32x48.png', { frameWidth: 32, frameHeight: 48 });
      this.load.script('webfont', 'https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js');
    }

    function create() {

      platforms = this.physics.add.staticGroup();
      platforms2 = this.physics.add.staticGroup();
      platforms3 = this.physics.add.staticGroup();
      platforms4 = this.physics.add.staticGroup();

      const width = window.innerWidth;
      const height = window.innerHeight;
      const q = Math.floor(width / 32);
      const h = Math.floor(height / 32);

      onit = true;

      for (let i = 0; i < q / 2; i++) {
        for (let k = 0; k < h / 2; k++) {
          platforms4
            .create(64 * i, 64 * k, 'background', 159)
            .setScale(2)
            .refreshBody();
        }
      }


      platforms.create(30, 30, 'background',20).setScale(2).refreshBody();
      for (i=1;i<q-1;i++){
        platforms.create((30+i*64), 30, 'background',21).setScale(2).refreshBody();
      }
      for (i=1;i<h-12;i++){
        platforms.create(30, (30+i*64), 'background',39).setScale(2).refreshBody();
      }
      for (i=1;i<h-12;i++){
        platforms.create(30, (30+i*64), 'background',39).setScale(2).refreshBody();
      }
      for (i=1;i<h-12;i++){
        platforms.create((q*32-32), (30+i*64), 'background',41).setScale(2).refreshBody();
      }
      platforms.create(30, (h*32-32), 'background',58).setScale(2).refreshBody();
      for (i=1;i<q-1;i++){
        platforms.create((30+i*64), (h*32-32), 'background',59).setScale(2).refreshBody();
      }
      platforms.create((q*32-32), 30, 'background',22).setScale(2).refreshBody();
      platforms.create((q*32-32), (h*32-32), 'background',60).setScale(2).refreshBody();

      platforms2.create((q*32-70), 62, 'background',25).setScale(2).refreshBody();
      platforms3.create((160-58), 62, 'background',25).setScale(2).refreshBody();

      el = this.physics.add.sprite((q*32-158), 158, 'elevator',0).setScale(4).refreshBody();
      el2 = this.physics.add.sprite(160, 158, 'elevator',0).setScale(4).refreshBody();



      player = this.physics.add.sprite(160, 120, 'forward_e').setScale(0.4).refreshBody();
      player.angle = 180;
      player.setBounce(0.1);
      player.setCollideWorldBounds(true);
      this.physics.world.gravity.y = -300;
      this.physics.add.collider(player, platforms);
      this.physics.add.collider(player, platforms2, () => {
        player.setVelocityX(0);
        player.anims.stop();
        player.anims.play("still");
        el.anims.play("open");
        this.children.bringToTop(el);
        el.anims.play("close");
        window.location.href = "https://summer.hackclub.com/s?scene=37";
      });
      this.physics.add.collider(player, platforms3, () => {
        player.setVelocityX(0);
        player.anims.stop();
        player.anims.play("still");
        el2.anims.play("open");
        this.children.bringToTop(el);
        el2.anims.play("close");
        if (!onit){
            onit = true;
            window.location.href = "index.html";
        }
      });
      this.physics.add.collider(el, platforms);
      this.physics.add.collider(el2, platforms);


      this.add.image(this.cameras.main.width / 2,this.cameras.main.height / 2,'msg').setScale(0.2);

      this.anims.create({
          key: 'left',
          frames: [ { key: 'left_moving'},{ key: 'left_still'} ],
          frameRate: 10,
          repeat: -1
      });

      this.anims.create({
          key: 'still',
          frames: [ { key: 'forward_e'} ],
          frameRate: 1
      });

      this.anims.create({
          key: 'open',
          frames: this.anims.generateFrameNumbers('elevator', { start: 0, end: 7 }),
          frameRate: 40
      });

      this.anims.create({
          key: 'close',
          frames: this.anims.generateFrameNumbers('elevator', { start: 7, end: 0 }),
          frameRate: 40
      });

      this.anims.create({
          key: 'right',
          frames: [ { key: 'right_moving'},{ key: 'right_still'} ],
          frameRate: 10,
          repeat: -1
      });

      let isTouchScrolling = false;

      this.input.on('pointermove', (pointer) => {
          if (pointer.isDown && pointer.wasTouch) {
              isTouchScrolling = true;
              if (deltaY > 0) {
                  player.setVelocityX(400);
                  player.anims.play('right', true);
              }
              else if (deltaY < 0) {
                  player.setVelocityX(-400);
                  player.anims.play('left', true);
              }
            
              if (deltaY==0 && player.body.touching.down)
              {
                  player.setVelocityY(0);
              }
              onit = false;
          }
      });

      this.input.on('pointerup', () => {
          if (isTouchScrolling) {
              console.log("Touch scroll ended");
              isTouchScrolling = false;
              player.setVelocityX(0);
              player.anims.stop();
              player.anims.play('still')
          }
      });

      this.input.on("wheel",  (pointer, gameObjects, deltaX, deltaY, deltaZ) => {
        if (deltaY > 0) {
            player.setVelocityX(400);
            player.anims.play('right', true);
        }
        else if (deltaY < 0) {
            player.setVelocityX(-400);
            player.anims.play('left', true);
        }

        if (deltaY==0 && player.body.touching.down)
        {
            player.setVelocityY(0);
        }
        onit = false;

        clearTimeout(this.scrollTimeout);
        this.scrollTimeout = setTimeout(() => {
          player.setVelocityX(0);
          player.anims.stop();
          player.anims.play('still')
        }, 200);
      });
    }

    function update (){

    }

    window.addEventListener('resize', () => location.reload());
  </script>
</body>
</html>
